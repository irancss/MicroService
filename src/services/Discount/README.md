# Ø³Ø±ÙˆÛŒØ³ ØªØ®ÙÛŒÙ (Discount Service)

ÛŒÚ© Ù…ÛŒÚ©Ø±ÙˆØ³Ø±ÙˆÛŒØ³ Ú©Ø§Ù…Ù„ Ùˆ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†ÙˆØ§Ø¹ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ØªØ¬Ø§Ø±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ØŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ .NET 8 Ùˆ Ù…Ø¹Ù…Ø§Ø±ÛŒ Clean Architecture.

## ğŸš€ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

### ğŸ¯ Ø§Ù†ÙˆØ§Ø¹ ØªØ®ÙÛŒÙ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡:
- **ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ (Percentage)**: Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ¹ÛŒÛŒÙ† Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ
- **ØªØ®ÙÛŒÙ Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Fixed Amount)**: Ù…Ø¨Ù„Øº Ù…Ø´Ø®Øµ ØªØ®ÙÛŒÙ
- **Ø®Ø±ÛŒØ¯ XØŒ Ø¯Ø±ÛŒØ§ÙØª Y Ø±Ø§ÛŒÚ¯Ø§Ù† (BOGO)**: Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø®Ø±ÛŒØ¯ Ùˆ Ù‡Ø¯ÛŒÙ‡
- **Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ÛŒÚ¯Ø§Ù† (Free Shipping)**: ØªØ®ÙÛŒÙ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„

### ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ:
- **.NET 8**: Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ ÙØ±ÛŒÙ…ÙˆØ±Ú© .NET
- **Clean Architecture**: Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ dependencies
- **PostgreSQL**: Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ Ùˆ Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±
- **Redis**: Ú©Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§Ù„Ø§
- **RabbitMQ + MassTransit**: Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†ÛŒ event-driven
- **Docker**: Ú©Ø§Ù†ØªÛŒÙ†Ø±ÛŒØ²Ù‡ Ø´Ø¯Ù† Ú©Ø§Ù…Ù„

### ğŸ”§ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ:
- **CQRS Ø¨Ø§ MediatR**: Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Command Ùˆ Query
- **Repository Pattern**: Ø§Ù†ØªØ²Ø§Ø¹ Ù„Ø§ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡
- **Unit of Work**: Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
- **Specification Pattern**: Ù…Ù†Ø·Ù‚ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§

### ğŸ›¡ï¸ Ø§Ù…Ù†ÛŒØª Ùˆ Ú©ÛŒÙÛŒØª:
- **JWT Authentication**: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ù…Ù†
- **Role-based Authorization**: Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ù†Ù‚Ø´
- **FluentValidation**: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
- **Rate Limiting**: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
- **Health Checks**: Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø³Ù„Ø§Ù…Øª Ø³Ø±ÙˆÛŒØ³

## ğŸ“ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡

```
DiscountService/
â”œâ”€â”€ DiscountService.Domain/          # Ù„Ø§ÛŒÙ‡ Domain - Ù…Ù†Ø·Ù‚ Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø± Ø§ØµÙ„ÛŒ
â”‚   â”œâ”€â”€ Entities/                    # Ù…ÙˆØ¬ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Discount, DiscountUsageHistory)
â”‚   â”œâ”€â”€ Enums/                       # Ø§Ù†ÙˆØ§Ø¹ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
â”‚   â”œâ”€â”€ ValueObjects/                # Value Objects (Cart, DiscountCalculationResult)
â”‚   â”œâ”€â”€ Services/                    # Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Domain (DiscountCalculationService)
â”‚   â””â”€â”€ Events/                      # Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Domain
â”œâ”€â”€ DiscountService.Application/     # Ù„Ø§ÛŒÙ‡ Application - Use Cases
â”‚   â”œâ”€â”€ DTOs/                        # Data Transfer Objects
â”‚   â”œâ”€â”€ Features/                    # Commands Ùˆ Queries (CQRS)
â”‚   â”œâ”€â”€ Handlers/                    # MediatR handlers
â”‚   â”œâ”€â”€ Interfaces/                  # Ø±Ø§Ø¨Ø·â€ŒÙ‡Ø§ÛŒ Repository Ùˆ Service
â”‚   â”œâ”€â”€ Mappings/                    # Ù¾Ø±ÙˆÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ AutoMapper
â”‚   â””â”€â”€ Validators/                  # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬â€ŒÙ‡Ø§ÛŒ FluentValidation
â”œâ”€â”€ DiscountService.Infrastructure/  # Ù„Ø§ÛŒÙ‡ Infrastructure - Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡
â”‚   â”œâ”€â”€ Data/                        # Entity Framework DbContext
â”‚   â”œâ”€â”€ Repositories/                # Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Repository Ù‡Ø§
â”‚   â”œâ”€â”€ Services/                    # Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
â”‚   â””â”€â”€ Messaging/                   # Consumer Ù‡Ø§ÛŒ RabbitMQ
â””â”€â”€ DiscountService.API/             # Ù„Ø§ÛŒÙ‡ API - Controllers Ùˆ ÙˆØ±ÙˆØ¯ÛŒ
    â”œâ”€â”€ Controllers/                 # Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ÛŒ API
    â””â”€â”€ Program.cs                   # Ù†Ù‚Ø·Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
```

## ğŸ¯ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

### Ø§Ù†ÙˆØ§Ø¹ ØªØ®ÙÛŒÙ:
- **ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ**: Ø§Ø¹Ù…Ø§Ù„ Ø¯Ø±ØµØ¯ ØªØ®ÙÛŒÙ (Ù…Ø«Ù„ 20% ØªØ®ÙÛŒÙ)
- **ØªØ®ÙÛŒÙ Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª**: Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¨Ù„Øº Ù…Ø´Ø®Øµ ØªØ®ÙÛŒÙ (Ù…Ø«Ù„ 50 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† ØªØ®ÙÛŒÙ)
- **Ø®Ø±ÛŒØ¯ XØŒ Ø¯Ø±ÛŒØ§ÙØª Y Ø±Ø§ÛŒÚ¯Ø§Ù†**: Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ØªØ±ÙˆÛŒØ¬ÛŒ (Ù…Ø«Ù„ Ø®Ø±ÛŒØ¯ 2 Ø¹Ø¯Ø¯ØŒ 1 Ø¹Ø¯Ø¯ Ø±Ø§ÛŒÚ¯Ø§Ù†)
- **Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ÛŒÚ¯Ø§Ù†**: Ø­Ø°Ù Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ø´Ø±Ø§ÛŒØ· Ø®Ø§Øµ

### Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØ®ÙÛŒÙ:
- **Ú©Ø¯Ù‡Ø§ÛŒ ØªØ®ÙÛŒÙ**: Ú©Ø¯Ù‡Ø§ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± (Ù…Ø«Ù„ "RAMADAN20")
- **ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±**: Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ú©Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- **ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ**: ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø®Ø§Øµ

### Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø± Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§:
- **Ø¯ÙˆØ±Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±**: ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ®ÙÛŒÙ
- **Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡**: Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±
- **Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº Ø³Ø¨Ø¯**: Ø´Ø±Ø§ÛŒØ· Ø¢Ø³ØªØ§Ù†Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
- **Applicability**: Cart-wide, specific products, or specific categories
- **Combinability**: Control whether discounts can be stacked
- **Priority System**: Intelligent discount selection for maximum savings

### API Endpoints

#### Public Endpoints
- `POST /api/discounts/calculate` - Calculate best discount for a cart

#### Admin Endpoints (Requires Admin Role)
- `POST /api/admin/discounts` - Create new discount
- `GET /api/admin/discounts/{id}` - Get discount by ID
- `GET /api/admin/discounts` - Get paginated discounts list
- `PUT /api/admin/discounts/{id}` - Update existing discount
- `DELETE /api/admin/discounts/{id}` - Deactivate discount
- `GET /api/admin/discounts/{id}/usage-history` - Get usage history

#### User Endpoints (Requires Authentication)
- `GET /api/users/discounts/my-discount-history` - Get user's discount history

## ğŸ› ï¸ Technology Stack

### Core Technologies
- **.NET 8**: Latest framework with performance improvements
- **PostgreSQL**: Primary database with Entity Framework Core
- **Redis**: High-performance caching layer
- **RabbitMQ**: Message broker for event-driven communication
- **Docker**: Containerization for deployment

### Libraries & Packages
- **MediatR**: CQRS pattern implementation
- **AutoMapper**: Object-to-object mapping
- **FluentValidation**: Input validation
- **Serilog**: Structured logging
- **MassTransit**: Message bus abstraction
- **Swashbuckle**: OpenAPI/Swagger documentation

## ğŸš€ Getting Started

### Prerequisites
- .NET 8 SDK
- Docker & Docker Compose
- PostgreSQL (if running locally)
- Redis (if running locally)
- RabbitMQ (if running locally)

### Quick Start with Docker Compose

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd discount-service
   ```

2. **Run with Docker Compose**
   ```bash
   docker-compose up -d
   ```

3. **Access the API**
   - API: http://localhost:8080
   - Swagger UI: http://localhost:8080/swagger
   - Health Check: http://localhost:8080/health

### Local Development Setup

1. **Update connection strings in `appsettings.Development.json`**
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Host=localhost;Database=DiscountServiceDb_Dev;Username=postgres;Password=your_password",
       "Redis": "localhost:6379",
       "RabbitMQ": "rabbitmq://guest:guest@localhost:5672/"
     }
   }
   ```

2. **Run the application**
   ```bash
   cd DiscountService.API
   dotnet run
   ```

## ğŸ“Š Database Schema

### Discount Table
```sql
CREATE TABLE Discounts (
    Id UUID PRIMARY KEY,
    Name VARCHAR(200) NOT NULL,
    Description VARCHAR(1000) NOT NULL,
    CouponCode VARCHAR(50) UNIQUE,
    Type INT NOT NULL,
    Value DECIMAL(18,2) NOT NULL,
    StartDate TIMESTAMP NOT NULL,
    EndDate TIMESTAMP NOT NULL,
    IsActive BOOLEAN NOT NULL,
    IsAutomatic BOOLEAN NOT NULL,
    IsCombinableWithOthers BOOLEAN NOT NULL,
    MaxTotalUsage INT,
    MaxUsagePerUser INT,
    CurrentTotalUsage INT NOT NULL DEFAULT 0,
    MinimumCartAmount DECIMAL(18,2),
    MaximumDiscountAmount DECIMAL(18,2),
    Applicability INT NOT NULL,
    ApplicableProductIds TEXT,
    ApplicableCategoryIds TEXT,
    BuyQuantity INT,
    GetQuantity INT,
    UserId UUID,
    CreatedAt TIMESTAMP NOT NULL,
    UpdatedAt TIMESTAMP NOT NULL,
    CreatedBy VARCHAR(100) NOT NULL,
    UpdatedBy VARCHAR(100) NOT NULL
);
```

### DiscountUsageHistory Table
```sql
CREATE TABLE DiscountUsageHistories (
    Id UUID PRIMARY KEY,
    DiscountId UUID NOT NULL REFERENCES Discounts(Id),
    UserId UUID NOT NULL,
    OrderId UUID NOT NULL UNIQUE,
    DiscountAmount DECIMAL(18,2) NOT NULL,
    CartTotal DECIMAL(18,2) NOT NULL,
    FinalTotal DECIMAL(18,2) NOT NULL,
    CouponCode VARCHAR(50),
    UsedAt TIMESTAMP NOT NULL,
    UserEmail VARCHAR(255) NOT NULL
);
```

## ğŸ”„ Event-Driven Architecture

The service subscribes to `OrderCreatedEvent` from RabbitMQ to:
- Record discount usage in history
- Update usage counters
- Invalidate relevant cache entries

```csharp
public class OrderCreatedEvent
{
    public Guid OrderId { get; set; }
    public Guid UserId { get; set; }
    public string UserEmail { get; set; }
    public decimal CartTotal { get; set; }
    public decimal FinalTotal { get; set; }
    public Guid? DiscountId { get; set; }
    public string? CouponCode { get; set; }
    public decimal DiscountAmount { get; set; }
    public DateTime OrderCreatedAt { get; set; }
}
```

## ğŸ“ˆ Performance Optimizations

### Caching Strategy
- **Automatic Discounts**: Cached for 5 minutes
- **Coupon Codes**: Cached for 10 minutes
- **Individual Discounts**: Cached for 15 minutes

### Database Optimizations
- Indexed fields: `CouponCode`, `IsActive`, `IsAutomatic`, `StartDate`, `EndDate`, `UserId`
- Optimized queries with Entity Framework Core
- Connection pooling for PostgreSQL

### Redis Implementation
- JSON serialization for complex objects
- Automatic cache invalidation on updates
- Pattern-based cache clearing

## ğŸ§ª Example API Usage

### Calculate Discount
```bash
curl -X POST "http://localhost:8080/api/discounts/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "123e4567-e89b-12d3-a456-426614174000",
    "items": [
      {
        "productId": "123e4567-e89b-12d3-a456-426614174001",
        "productName": "Laptop",
        "categoryId": "123e4567-e89b-12d3-a456-426614174002",
        "categoryName": "Electronics",
        "unitPrice": 1500000,
        "quantity": 1
      }
    ],
    "shippingCost": 50000,
    "couponCode": "SAVE20"
  }'
```

### Create Discount (Admin)
```bash
curl -X POST "http://localhost:8080/api/admin/discounts" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "name": "Summer Sale",
    "description": "20% off all electronics",
    "couponCode": "SUMMER20",
    "type": 1,
    "value": 20,
    "startDate": "2024-06-01T00:00:00Z",
    "endDate": "2024-08-31T23:59:59Z",
    "isAutomatic": true,
    "isCombinableWithOthers": false,
    "maxTotalUsage": 1000,
    "minimumCartAmount": 500000,
    "applicability": 3,
    "applicableCategoryIds": ["123e4567-e89b-12d3-a456-426614174002"]
  }'
```

## ğŸ”’ Security Features

- **JWT Authentication**: Secure API access
- **Role-based Authorization**: Admin-only endpoints
- **Input Validation**: Comprehensive request validation
- **SQL Injection Protection**: Parameterized queries
- **CORS Configuration**: Configurable cross-origin requests

## ğŸ“‹ Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `ASPNETCORE_ENVIRONMENT` | Environment name | `Production` |
| `ConnectionStrings__DefaultConnection` | PostgreSQL connection | Required |
| `ConnectionStrings__Redis` | Redis connection | Required |
| `ConnectionStrings__RabbitMQ` | RabbitMQ connection | Required |
| `Jwt__Key` | JWT signing key | Required |
| `Jwt__Issuer` | JWT issuer | Required |
| `Jwt__Audience` | JWT audience | Required |

## ğŸ¥ Health Checks

The service includes health checks for:
- Database connectivity
- Redis connectivity
- Overall service health

Access health check at: `GET /health`

## ğŸ“ Logging

Structured logging with Serilog:
- **Console**: Development and debugging
- **File**: Persistent logs with daily rotation
- **Structured Format**: JSON-compatible logging

## ğŸš€ Deployment

### Production Deployment
1. Build Docker image: `docker build -t discount-service .`
2. Deploy to container orchestrator (Kubernetes, Docker Swarm)
3. Configure environment variables
4. Set up monitoring and logging aggregation

### Monitoring
- Health checks for container orchestrators
- Structured logs for centralized logging
- Performance metrics through built-in ASP.NET Core metrics

## ğŸ”„ Future Enhancements

- [ ] Discount scheduling with advanced rules
- [ ] A/B testing for discount campaigns
- [ ] Advanced analytics and reporting
- [ ] Machine learning for personalized discounts
- [ ] Integration with external promotion systems
- [ ] Real-time discount recommendations

## ğŸ“ Support

For questions and support:
- Check the API documentation at `/swagger`
- Review the structured logs in the `logs/` directory
- Monitor health endpoints for service status

---

Built with â¤ï¸ using .NET 8 and Clean Architecture principles.
