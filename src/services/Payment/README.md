# Payment Microservice

ÛŒÚ© Ù…ÛŒÚ©Ø±ÙˆØ³Ø±ÙˆÛŒØ³ Ø¬Ø§Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¹Ù…Ø§Ø±ÛŒ ØªÙ…ÛŒØ² (Clean Architecture) Ú©Ù‡ Ø§Ø² 10+ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÛŒØ±Ø§Ù†ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

## ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ

### ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ
- **Clean Architecture**: Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
- **Domain-Driven Design**: Ù…Ø¯Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ù‚ÛŒÙ‚ domain Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Value Objects Ùˆ Entities
- **CQRS**: Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Command Ùˆ Query operations
- **Event-Driven**: Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø§ÛŒØ± Ù…ÛŒÚ©Ø±ÙˆØ³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§

### ğŸ’³ Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª
- **Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„** (Zarinpal) - Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ âœ…
- **Ø³Ø§Ù…Ø§Ù†** (Saman) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ù…Ù„Øª** (Mellat) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ù¾Ø§Ø±Ø³ÛŒØ§Ù†** (Parsian) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ø§ÛŒØ±Ø§Ù† Ú©ÛŒØ´** (IranKish) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯** (Pasargad) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ø³Ù¾Ù‡Ø±** (Sepehr) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ø¯ÛŒØ¬ÛŒâ€ŒÙ¾ÛŒ** (Digipay) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ø³Ø¯Ø§Ø¯** (Sadad) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„
- **Ø¢Ø³Ø§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª** (AsanPardakht) - Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡ ğŸ”„

### ğŸ’° Ø³ÛŒØ³ØªÙ… Ú©ÛŒÙ Ù¾ÙˆÙ„
- Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
- Ø¹Ù…Ù„ÛŒØ§Øª ÙˆØ§Ø±ÛŒØ² (Deposit)
- Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø¯Ø§Ø´Øª (Withdrawal)
- Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ø§Ø¹ØªØ¨Ø§Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„ (Purchase)
- Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„

### ğŸ”„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
- Ø¨Ø§Ø²Ú¯Ø´Øª Ú©Ø§Ù…Ù„ ÛŒØ§ Ø¬Ø²Ø¦ÛŒ
- Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙˆØ¶Ø¹ÛŒØª refund
- ØªØ§ÛŒÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± ÛŒØ§ Ø¯Ø³ØªÛŒ

### ğŸ“Š ØªØ·Ø¨ÛŒÙ‚ Ø­Ø³Ø§Ø¨ (Reconciliation)
- Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
- Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§
- Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ

### ğŸ› ï¸ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§

#### Backend
- **.NET 8.0**: Ù¾Ù„ØªÙØ±Ù… Ø§ØµÙ„ÛŒ
- **Entity Framework Core**: ORM Ø¨Ø±Ø§ÛŒ PostgreSQL
- **MediatR**: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ CQRS
- **FluentValidation**: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§

#### Database & Storage
- **PostgreSQL**: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ØµÙ„ÛŒ (Ø±Ù…Ø²: 123)
- **MongoDB**: Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§
- **Redis**: Ú©Ø´ Ú©Ø±Ø¯Ù† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª

#### Messaging & Events
- **RabbitMQ**: Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Event-Driven Architecture

#### Logging & Monitoring
- **Serilog**: Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡
- **Seq**: Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙ…Ø±Ú©Ø² Ù„Ø§Ú¯â€ŒÙ‡Ø§
- **Health Checks**: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§

#### Security
- **JWT Authentication**: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ØªÙˆÚ©Ù†â€ŒÙ…Ø­ÙˆØ±
- **Role-based Authorization**: Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ù‚Ø´â€ŒÙ…Ø­ÙˆØ± (Admin, Operator)

## ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ

### Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
```bash
# PostgreSQL
docker run --name postgres -e POSTGRES_PASSWORD=123 -p 5432:5432 -d postgres

# MongoDB  
docker run --name mongo -p 27017:27017 -d mongo

# Redis
docker run --name redis -p 6379:6379 -d redis

# RabbitMQ
docker run --name rabbitmq -p 5672:5672 -p 15672:15672 -d rabbitmq:3-management

# Seq (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
docker run --name seq -e ACCEPT_EULA=Y -p 5341:80 -d datalust/seq
```

### Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
```bash
cd Payment.API
dotnet run
```

### Migration Ø¯ÛŒØªØ§Ø¨ÛŒØ³
```bash
cd Payment.API
dotnet ef database update
```

## ğŸ“¡ API Endpoints

### Authentication Required
- `POST /api/payment/initiate` - Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª
- `GET /api/payment/gateways` - Ù„ÛŒØ³Øª Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
- `GET /api/payment/transaction/{id}` - Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´
- `POST /api/payment/refund` - Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ (Admin/Operator)

### Wallet Management
- `GET /api/wallet` - Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ÛŒÙ Ù¾ÙˆÙ„
- `POST /api/wallet/deposit` - ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
- `POST /api/wallet/withdraw` - Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
- `POST /api/wallet/purchase` - Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„

### Gateway Callbacks (No Auth)
- `GET/POST /api/payment/verify/{gatewayName}` - ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª

### Health Checks
- `GET /api/health` - Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„ÛŒ Ø³Ù„Ø§Ù…Øª
- `GET /api/health/detailed` - Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø³Ù„Ø§Ù…Øª

## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª

### appsettings.json
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=PaymentDB;Username=postgres;Password=123;Port=5432",
    "MongoDB": "mongodb://localhost:27017",
    "Redis": "localhost:6379"
  },
  "PaymentGateways": {
    "Zarinpal": {
      "IsEnabled": true,
      "IsTest": true,
      "MerchantId": "YOUR_MERCHANT_ID"
    }
  }
}
```

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation  â”‚    â”‚   Application   â”‚    â”‚     Domain      â”‚
â”‚    (API)        â”‚â”€â”€â”€â–¶â”‚   (Use Cases)   â”‚â”€â”€â”€â–¶â”‚   (Entities)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ Infrastructure  â”‚    â”‚   External      â”‚              â”‚
â”‚ (Data/Services) â”‚    â”‚   Services      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     External Systems      â”‚
                    â”‚ PostgreSQLâ”‚MongoDBâ”‚Redis  â”‚
                    â”‚ RabbitMQ â”‚Payment Gatewaysâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security Features

- **JWT-based Authentication**: Ù‡Ù…Ù‡ endpoint Ù‡Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ø§Ø±Ù†Ø¯
- **Role-based Authorization**: 
  - `Admin`: Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ + Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
  - `Operator`: Ù…Ø¯ÛŒØ±ÛŒØª refund
  - `User`: Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ú©ÛŒÙ Ù¾ÙˆÙ„
- **Test Gateway Access**: ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯
- **Input Validation**: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø§Ù…Ù„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ FluentValidation
- **Security Headers**: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ

## ğŸ“ˆ Monitoring & Logging

- **Structured Logging**: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Serilog
- **Health Checks**: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯Ø§ÙˆÙ… Ø³Ù„Ø§Ù…Øª dependencies
- **Gateway Request/Response Logging**: Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù…Ù„ Ø¯Ø± MongoDB
- **Event Publishing**: Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ monitoring

## ğŸ”„ Event-Driven Integration

Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡:
- `PaymentSucceededEvent`: Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚
- `PaymentFailedEvent`: Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚  
- `WalletDepositedEvent`: ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
- `WalletWithdrawnEvent`: Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
- `WalletPurchaseEvent`: Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„

## ğŸš§ TODO

- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø³Ø§ÛŒØ± Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª
- [ ] Background Service Ø¨Ø±Ø§ÛŒ Reconciliation
- [ ] Admin Dashboard
- [ ] Retry Policy Ø¨Ø±Ø§ÛŒ failed transactions
- [ ] Rate Limiting
- [ ] API Versioning
- [ ] Docker Compose setup
- [ ] Integration Tests
- [ ] Performance Tests

## ğŸ“ Support

Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒØŒ Ù„Ø·ÙØ§Ù‹ issue Ø¬Ø¯ÛŒØ¯ Ø¯Ø± repository Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.

---
**Ù†Ú©ØªÙ‡**: Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ production Ø§Ø³Øª Ùˆ Ø§Ø² Ø¨Ù‡ØªØ±ÛŒÙ† practices Ù…Ø·Ø§Ø¨Ù‚ Clean Architecture Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
